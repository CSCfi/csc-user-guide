# Setting up SSH keys

--8<-- "ssh-ca.md"

[SSH keys](https://www.ssh.com/academy/ssh-keys) provide more convenient and
secure authentication. SSH keys are required to be able to connect to CSC
supercomputers using an SSH client. Connecting to Roihu requires also that you
sign your public key in order to obtain a time-based SSH certificate.

1. [Generate SSH keys on your local workstation](#generating-ssh-keys).
    - SSH keys are always generated in pairs consisting of one _public key_ and
      one _private key_. Generate these keys on the device you intend to use to
      connect to CSC supercomputers. **Never share the private key with
      anyone!**
2. [Copy the public key from your workstation to MyCSC](#copying-public-key-to-supercomputer).
    - For authenticating an SSH connection using a key pair, you need to copy
      the _public key_ to MyCSC. **Do not copy the private key.** Note that
      copying the public key directly to CSC supercomputers using tools such as
      `ssh-copy-id` will not work.
3. [Sign the public key in MyCSC and download SSH certificate](#signing-public-key) (**required for Roihu only**).
    - To connect to Roihu, sign your public key in MyCSC to generate a
      time-based SSH certificate that is used for authentication. SSH
      certificates have a finite lifetime of 24 hours, which significantly
      improves the security of the system. After the SSH certificate expires, a
      new one must be generated by signing the public key in MyCSC again.

For more information about SSH keys, see:

- [Tutorial: Setting up SSH keys at CSC](https://csc-training.github.io/csc-env-eff/hands-on/connecting/ssh-keys.html)
- [FAQ: Troubleshooting issues with SSH keys](../../support/faq/ssh-keys-not-working.md).

## Generating SSH keys

To find out how to generate SSH keys on your local workstation, see the
system-specific instructions for:

1. [Unix-based systems](ssh-unix.md) (macOS and Linux)
2. [Windows systems](ssh-windows.md)

!!! warning
    The private key should **never** be shared with anyone, not even with CSC
    staff! It should only be stored on the local workstation.

    Also, never leave the passphrase empty when generating an SSH key pair!
    Please choose a secure passphrase. It should be at least 8 characters long
    and contain numbers, letters and special characters.

## Copying public key to supercomputer

The only way to copy a public key to a supercomputer is through the MyCSC
customer portal.
[Read the instructions below](ssh-keys.md#adding-public-key-in-mycsc).

### Adding public key in MyCSC

You can add your public key through the
[MyCSC customer portal](https://my.csc.fi) by following these steps:

1. Log in to MyCSC with your CSC or Haka/Virtu credentials.
2. Select _Profile_ from the left-hand navigation or the dropdown menu in the
   top-right corner.
3. Locate _SSH PUBLIC KEYS_ section and select _+ Add key_. As a security
   measure, you are asked to log in again if it has been a few minutes since
   you last logged into the portal.

    ![Add key](https://a3s.fi/docs-files/ssh-no-keys.png 'Add key')

4. Add your public key by either
    1. uploading the public key file in the _Upload file_ tab, or
    2. manually pasting its contents into the _Key_ field in the _Manual input_
       tab. In this case, also add a _Title_ for the key, e.g. "my-ssh-key".

        === "Upload file"
            ![Upload file](https://a3s.fi/docs-files/ssh-upload-file.png 'Upload file')

        === "Manual input"
            ![Manual input](https://a3s.fi/docs-files/ssh-manual-input.png 'Manual input')

5. Select _Upload_ or _Add_.
6. You should now see your new key listed under _SSH PUBLIC KEYS_. Note that
   it might take up to one hour for your new key to become active. If it takes
   longer than that, please
   [contact the CSC Service Desk](../../support/contact.md).

    ![New key added](https://a3s.fi/docs-files/ssh-key-added.png 'New key added')

!!! info "Supported key types and formatting"
    Supported key types are Ed25519 and RSA 4096 through 16384. **We strongly
    recommend Ed25519**.

    Your public key should consist of the SSH key type, the key sequence and an
    optional comment, all separated by single spaces. Make sure to add the
    whole SSH key on the same line and do not add other whitespace than normal
    space characters. If your key is improperly formatted, an error message is
    displayed. A key in the correct format looks like this:
    ```
    ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDlapOdeoxNvz/1AZFRjGAPnPj8pzzz3skI+a+yJS5b7 optional-comment
    ```

Users can check their public keys on Puhti or Mahti using the commands:

```bash
# Check timestamp of file (time of previous sync)
ls -l /var/lib/acco/sshkeys/${USER}/${USER}.pub

# Check its contents (public keys)
cat /var/lib/acco/sshkeys/${USER}/${USER}.pub
```

If you have added multiple keys to MyCSC, they should all be visible in the
same `${USER}.pub` file.

## Signing public key

!!! info "The following is a requirement for connecting to Roihu only"

To connect to Roihu using SSH, you must sign your public key to get a so called
**SSH certificate**. SSH certificates significantly improve the security of the
system by introducing an additional authentication factor for SSH logins.

**SSH certficates are valid for 24 hours at a time**. Once your certificate
expires, a new one must be signed following either of the processes below.

### Option 1: Certificate helper tool

The certificate helper is a Python tool developed by CSC to simplify the
process of signing and downloading SSH certificates. A detailed documentation
of the tool is available in the [source repository](https://github.com/CSCfi/).
The following instructions illustrate only basic usage.

1. Ensure that you have Python installed on your computer.
    - Instructions are available in the
      [Python Beginners Guide](https://wiki.python.org/moin/BeginnersGuide/Download).
      Contact your local IT-support if you need assistance.
    - If Python for some reason cannot be installed on your computer, fall
      back to [Option 2](#option-2-mycsc) instead.
2. [Download the certificate helper tool here](https://github.com/CSCfi/).
3. Run the tool:

    === "Linux & macOS"

        1. Open terminal and execute:

            ```bash
            # Replace <username> with your CSC user name and
            # <path-to-public-key> with the path to your SSH public key

            python3 csc-cert.py -u <username> <path-to-public-key>
            ```

        2. If you have an earlier certificate which is still valid, the tool
            exits.
        3. If signing is needed, a login URL is displayed. Follow the link and
            authenticate.
        4. Copy the 6-digit code displayed into your terminal and enter your
           SSH key passphrase.
            - The signed certificate is automatically downloaded and added to
              your SSH agent. The signed certificate is saved as
              `<key>-cert.pub` (e.g., `~/.ssh/id_ed25519-cert.pub`).
        5. Each SSH certificate is valid for 24 hours. The expiration time can
           be checked by running the tool again.

    === "Windows"

        1. Optional, but helpful:
            [Install WinSCP](https://winscp.net/eng/docs/installation) and
            [start the Pageant authentication agent](https://the.earth.li/~sgtatham/putty/0.83/htmldoc/Chapter9.html#pageant)
            that comes bundled with PuTTY to automatically add SSH key and
            certificate to SSH agent.
        2. Open PowerShell and execute:

            ```bash
            # Replace <username> with your CSC user name and
            # <path-to-public-key> with the path to your SSH public key

            python3 csc-cert.py -u <username> <path-to-public-key>
            ```

            !!! info "Note"
                PowerShell is just needed to run the certificate
                helper script. You can still connect to Roihu using your
                [favorite SSH client](ssh-windows.md#basic-usage).

        3.  If you have an earlier certificate which is still valid, the tool
            exits.
        4.  If signing is needed, a login URL is displayed. Follow the link and
            authenticate.
        5. Copy the displayed 6-digit code into PowerShell and enter your SSH
           key passphrase.
            - The signed certificate is automatically downloaded and added to
              your SSH agent (if you have WinSCP installed and Pageant
              running). The signed certificate is saved as `<key>-cert.pub`
              (e.g., `C:\Users\<username>\.ssh\id_ed25519-cert.pub`).
        6. Each SSH certificate is valid for 24 hours. The expiration time can
           be checked by running the tool again.

### Option 2: MyCSC

1. Log in to MyCSC with your CSC or Haka/Virtu credentials.
2. Select _Profile_ from the left-hand navigation or the dropdown menu in the
   top-right corner.
3. Locate _SSH PUBLIC KEYS_ section and click the three vertical dots next to
   the public key you want to sign.
4. Click _Sign SSH key_. As a security measure, you are asked to log in again.

    ![Sign SSH key](https://a3s.fi/docs-files/sign-ssh-key.png 'Sign SSH key')

5. Download the certificate by clicking the three vertical dots next to your
   public key and selecting _Download SSH certificate_.

    !!! info "Where to store the SSH certificate?"
        We **strongly** advice saving the certificate in the default folder for
        SSH-related files (e.g. `~/.ssh`). Specifically, storing the
        certificate in the same directory as your SSH private key **and**
        naming it as `<key>-cert.pub` will simplify connecting, working with
        SSH agent, etc.

        For example, if you've stored your SSH private key in
        `~/.ssh/id_ed25519`, please save your SSH certificate as
        `~/.ssh/id_ed25519-cert.pub`

    ![Download SSH certificate](https://a3s.fi/docs-files/download-ssh-cert.png 'Download SSH certificate')

6. Each SSH certificate is valid for 24 hours. The expiration time can be
   checked as follows:

    === "Terminal (Linux, macOS, PowerShell, MobaXterm)"

        1. Open a terminal client.
        2. Run command:

            ```bash
            ssh-keygen -L -f <path-to-certificate> | grep "Valid"
            ```

    === "GUI (PuTTY, MobaXterm)"

        3. Open PuTTYgen / MobaKeyGen.
        4. Load your private key: _File_ :material-arrow-right: _Load private key_.
        5. Add a certificate to the key: _Key_ :material-arrow-right: _Add certificate to key_.
        6. Select _Certificate info_ to see the validity period among other info.

    ---

## More information

- [Tutorial on setting up SSH keys at CSC](https://csc-training.github.io/csc-env-eff/hands-on/connecting/ssh-keys.html)
- [Troubleshooting issues with SSH keys](../../support/faq/ssh-keys-not-working.md)
- [Connecting to CSC supercomputers with SSH on Linux and macOS](ssh-unix.md)
- [Connecting to CSC supercomputers with SSH on Windows](ssh-windows.md)
