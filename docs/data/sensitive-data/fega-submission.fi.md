# Data submission {#data-submission}

Alla löydät vaiheittaiset ohjeet biolääketieteellisen datan lataamiseen, kuvaamiseen ja julkaisemiseen Finnish Federated EGA:n (FEGA) kautta. **Huomioithan, että prosessi voi olla pitkä** (vaihdellen yhdestä kuuteen kuukauteen), mutta tarjoamme tukea ja opastusta koko prosessin aikana.

Tässä käyttäjäoppaassa kuvattu prosessi koskee nimenomaan aineistojen lähettämistä Suomen FEGA:lle. Central EGA:lla ja muilla FEGA-solmuilla on omat aineistojen lähetysprosessinsa.

Lähetyspyynnöt käsitellään saapumisjärjestyksessä.

!!! Note
    Ennen aloittamista on erittäin tärkeää varmistaa, että CSC:n (tietojenkäsittelijä) ja kotiorganisaatiosi (tai rekisterinpitäjä) välillä on palvelusopimus erityisesti Federated EGA ‑palvelulle. **Aloita aineiston lähetyksen valmistelu hyvissä ajoin** (mieluiten jo ennen käsikirjoituksen lähettämistä tieteelliseen lehteen) ottamalla yhteyttä [CSC Service Deskiin](../../support/contact.md) (aihe: Federated EGA) sekä kotiorganisaatiosi lakipalveluihin.

## Step 1: Legal agreements, Data Access Committee and Policies {#step-1-legal-agreements-data-access-committee-and-policies}

Tiedon tallettaminen Finnish Federated EGA:an vaatii useita juridisia sopimuksia: Federated EGA:n palvelusopimus sekä Data Access Agreement (sisältäen Data Transfer Agreementin). Nämä sopimukset sekä datan myöhempi käyttöoikeuksien hallinta ovat rekisterinpitäjän vastuulla. Yleensä kotiorganisaatio, joka on mahdollistanut tutkimuksen, toimii lähetetyn datan rekisterinpitäjänä. Datan omistajuus ei muutu palvelun käytön myötä.

FEGA:lle datan lähettäminen kuuluu [CSC:n maksuttomiin käyttötapauksiin](https://research.csc.fi/free-of-charge-use-cases) Suomen akateemiseen tutkimuskäyttöön, mutta maksuton käyttö ei sisällä pakollista varmuuskopiota datasta. Varmuuskopiotallennus voidaan ostaa lisäpalveluna FEGA:lta, tai lähettävä organisaatio voi sopia muista tallennusratkaisuista CSC:n kanssa. Lisätietoa FEGA:n sisäisen varmuuskopiopalvelun hinnoista löytyy [hintaliitteestä](https://a3s.fi/docs-files/sensitive-data/PDF_instructions/federated-ega-pricing.pdf){ target=_blank }. Lähetyspalvelu on saatavilla vain suomalaisille käyttäjille.

Alla lisätietoa tarvittavista sopimuksista ja käyttöoikeuksien hallinnasta:

* **Federated EGA:n palvelusopimus**: Organisaatiollasi (tai rekisterinpitäjällä) tulee olla erityinen palvelusopimus CSC:n (tietojenkäsittelijä) kanssa ennen kuin pääsyä Finnish Federated EGA:n palveluun voidaan myöntää. Palvelusopimus sisältää tietojenkäsittelysopimuksen (Data Processing Agreement, DPA), joka määrittää tietojenkäsittelyn laajuuden ja tarkoituksen sekä rekisterinpitäjän ja -käsittelijän oikeudet ja velvollisuudet. Varmista, että organisaatiollasi on FEGA-palvelusopimus ennen aineiston lähetysprosessin käynnistämistä. Jos sopimus puuttuu, ota yhteyttä [CSC Service Desk](../../support/contact.md) (aihe: Federated EGA).

* **Data Access Agreement**: Data Access Agreement (DAA) on sopimus Data Access Committeen (DAC) ja datan uudelleenkäyttöä hakevan henkilön välillä. DAA:n avulla rekisterinpitäjä voi määrittää uudelleenkäytön ehdot ja rajoitukset, kuten tietojen käyttö-, julkaisu-, lataus- ja käyttöoikeuspolitiikat. DAA:han tulee liittää myös Data Transfer Agreement (DTA), joka on tarpeen jos tutkijoita EU- tai ETA-alueen ulkopuolelta käyttää aineistoa SD Desktopin kautta. DAA ja DTA liitetään käyttöoikeuspolitiikoihin (ks. seuraava kappale). Lisätietoa saa omalta organisaatiolta, Data Access Committeelta tai lakipalveluista. Esimerkkipohja löytyy [täältä](https://ega-archive.org/assets/files/Example_DAA.doc).

* **Data Access Committee ja Policies**: Data Access Committee (DAC) ja politiikat hallinnoi rekisterinpitäjä. Tietojen käyttöoikeudet sekä DAC- ja politiikkainformaatio hallitaan erillisessä palvelussa nimeltä [SD Apply](./sd-apply.md). Organisaatioilla voi olla yleisiä DAC:ja ja politiikkoja, joita käytetään kaikissa organisaation lähettämissä aineistoissa. Vain aineistokohtainen hakulinkki on yksilöllinen jokaiselle aineistolle. Tämä linkki luodaan, kun aineiston lähetys on vahvistettu FEGA-portaalissa ja aineiston yksilöllinen tunniste yhdistetään DAC:iin, politiikkoihin ja hakulomakkeeseen SD Applyssa. Varmistaaksesi, että organisaatiollasi on sopiva DAC ja politiikka aineistollesi, ota yhteyttä oman organisaatiosi edustajiin tai [CSC Service Desk](../../support/contact.md) saadaksesi tarkemmat ohjeet.

## Step 2: General information of the submission {#step-2-general-information-of-the-submission}

Aineiston lähetys Finnish Federated EGA -palveluun alkaa ottamalla yhteyttä FEGA-helpdeskiin ja toimittamalla lähetyksen yleiset tiedot. Ensisijaisesti tiedot toimitetaan oman organisaation DAC:lle, joka voi lähettää nämä tiedot FEGA-helpdeskiin hyväksyessään lähetyksen.

Aloita täyttämällä [yleistietolomake](https://a3s.fi/docs-files/sensitive-data/PDF_instructions/fega-general-information.pdf), johon merkitään yhteystiedot, lähetyksen tyyppi sekä rekisterinpitäjän tiedot – tai toimita vastaavat tiedot sähköpostitse. Lähetyspyyntö toimitetaan oman organisaation DAC:lle, joka voi edelleen välittää vaaditut tiedot sähköpostitse [CSC Service Deskille](../../support/contact.md) (aihe: Federated EGA).

## Step 3: Credentials {#step-3-credentials}

Kun juridiset sopimukset rekisterinpitäjän ja CSC:n välillä ovat valmiit ja DAC on hyväksynyt lähetyksen, voit rekisteröityä [EGA:n verkkosivulla](https://ega-archive.org/register/) luodaksesi Central EGA -tunnukset. Saat sähköpostiin aktivointilinkin rekisteröitymisen hyväksynnän jälkeen. Aktivoinnin jälkeen ota yhteyttä [CSC Service Deskiin](../../support/contact.md), jotta sinut lisätään Finnish FEGA -lähettäjäksi. Lisäksi ilmoita IP-osoite, josta tulet siirtämään datan FEGA:an, jotta yhteys FEGA-inboxiin saadaan toimimaan.

!!! note
    Central EGA -tunnukset, sisältäen käyttäjätunnuksen (yleensä sähköpostiosoitteesi) ja salasanan, tarvitaan aineiston salaukseen ja lähettämiseen FEGA:lle sekä aineiston metatietojen tallentamiseen lähettäjäportaalin kautta.

## Step 4: Data formats {#step-4-data-formats}
Ennen aineiston lähettämistä FEGA:an tulee valmistella datasetit ja varmistaa, että tiedostomuodot ovat hyväksyttyjä. Alla on esimerkkejä hyväksytyistä muodoista.

!!! note
    Datasetti määritellään yleensä joukoksi tiedostoja, jotka kuuluvat samaan kokeeseen ja tietotyyppiin. Yksi tutkimus voi sisältää useita datasettejä. Tutkimukseesi voi kuulua sekä sensitiivistä (esim. ihmisen geneettistä tai fenotyyppistä tietoa) että ei-sensitiivistä dataa (esim. virussekvenssejä, metaboliitteja). FEGA:an voi lähettää vain sensitiivistä aineistoa. Ei-sensitiiviset tiedot voi julkaista avoimesti sopivissa palveluissa. Tällöin näissä palveluissa luodut näytetunnisteet merkitään FEGA-lähetykseen viitteinä.
    
**Sensitiivinen data**:

- **sekvenssidata**: CRAM, BAM, FASTQ, VCF -formaatit

- **metagenomiikka**: EGA käyttää [Minimum Information about any (x) Sequence (MIxS)](https://www.gensc.org/pages/projects/mixs-gsc-project.html) -standardeja tämän tyyppisen tiedon kuvaamiseen.

- **fenotyyppitieto**: Ei erityistä formaattia. Suosituksena on käyttää Experimental Factor Ontologies -sanastoja. Fenotyyppitietojen kuvaamiseen ja oikeiden sanastojen hakemiseen käytä [Ontology Lookup Service (OLS)](https://www.ebi.ac.uk/ols/ontologies/efo), jonka on kehittänyt EMBL-EBI.

- **linkitystiedostot**: Mikäli samaan tutkimukseen kuuluvat ei-sensitiiviset datasetit on talletettu omaan arkistoon, näytteet voidaan linkittää FEGA:an lähetettyyn sensitiiviseen aineistoon. Jokaisessa arkistossa tulee kuitenkin käyttää eri anonymisoituja näytetunnisteita. Asianmukaisessa arkistossa saadut tunnisteet voidaan viitata FEGA-lähetykseen esimerkiksi ylimääräisessä `.txt`-tiedostossa, joka liitetään johonkin yllämainituista sensitiivisistä dataseteistä.

!!! note
    FEGA ei tue **array-dataa**. Lisätietoa array-data-aineistojen lähetyksestä saat [EGA:n verkkosivuilta](https://ega-archive.org/submission/metadata/submission/array/).

**Ei-sensitiivinen data**:

Ei-sensitiivinen data (tai avoin data) tulee lähettää asianmukaisiin arkistoihin. Esimerkiksi sekvenssejä varten [ENA, European Nucleotide Archive](https://www.ebi.ac.uk/ena/browser/home), variantteja varten [EVA, European Variation Archive](https://www.ebi.ac.uk/eva/), array-data ArrayExpressiin [ArrayExpress – functional genomics data](https://www.ebi.ac.uk/arrayexpress/), fenotyyppejä varten [BioSamples](https://www.ebi.ac.uk/biosamples/) ja GWAS-yhteenvetotilastoja [GWAS Catalogiin](https://www.ebi.ac.uk/gwas/).

!!! note
    Lisätietoa datatyypeistä ja -formaateista löydät [EGA:n lähetys-FAQ:ssa](https://ega-archive.org/submission/metadata/submission/FAQ/) tai kysymällä [CSC Service Deskistä](../../support/contact.md) (aihe: Federated EGA).

## Step 5: Data encryption and upload {#step-5-data-encryption-and-upload}
Seuraavaksi data voidaan lähettää Finnish FEGA:lle. Jokainen FEGA:aan lähetettävä tiedosto tulee salata.

!!! note
    Data salataan työkaluilla, jotka on suunniteltu ihmisen geneettisen datan salaamiseen ja jakamiseen Global Alliance for Genomics and Health (GA4GH) -standardin mukaisesti.

Salauksen ja lähetyksen voi tehdä kahdella tavalla:

- **Vaihtoehto 1 – Fi-FEGA-lähetyssovellus**. Fi-FEGA upload -sovellus (graafinen käyttöliittymä) mahdollistaa tiedostojen tai kansioiden automaattisen salauksen ja lähetyksen FEGA:lle.

tai

- **Vaihtoehto 2 – Komentorivisovellus**. Datan salaaminen crypt4gh CLI:llä ja lähetys sftp CLI:llä. Mikäli suosittelet komentorivikäyttöä, löydät tietoa salauksesta ja latauksesta alta.

### Option 1 - Fi-FEGA upload application {#option-1---fi-fega-upload-application}

1. Lataa käyttöjärjestelmällesi sopiva Fi-FEGA upload -sovellus [GitHub-repositorysta](https://github.com/CSCfi/sda-uploader/releases): Linux, Mac tai Windows – valitse sdagui-vaihtoehdoista. Purkamisen jälkeen löydät sovelluksen latauskansiosta. Sovellusta avatessa voi ilmetä virheilmoitus – klikkaa tässä tapauksessa *More info* ja tarkista, että julkaisija on CSC-IT Center for Science (tai suomeksi: CSC-Tieteen tietotekniikan keskus Oy), ja klikkaa *Run anyway*.

2. Lataa seuraavaksi [Finnish FEGA:n julkinen salausavain](https://a3s.fi/fega-public-keys/fega-pubkey-c4gh.pub).

3. Avaa lähetyssovellus ja klikkaa *Load recipient public key*. Avautuu tiedostoselain, jolla voit valita Finnish FEGA:n julkisen salausavaimen (`fega-pubkey-c4gh.pub`). Klikkaa seuraavaksi *Open*.

4. Klikkaa *Select file to upload* tai *Select directory to upload* ladataksesi yksittäisen tiedoston tai kokonaisen kansion.

5. Täytä SFTP-yhteystiedot, jotka ovat Central EGA -tilisi käyttäjätunnus. SFTP Username: kirjoita EGA-tunnuksesi (yleensä sähköpostiosoitteesi). SFTP Server: kirjoita `admin.sd.csc.fi:50529`. SFTP-avain ei ole pakollinen FEGA:an lähettäessä.

6. Klikkaa *Encrypt and upload files*. Työkalu kysyy SFTP Passphraseä, joka on Central EGA -tilisi salasana. Klikkaa OK, ja sovellus aloittaa salauksen ja lähetyksen.

7. Sovelluksessa ei ole etenemispalkkia. Salaus ja aineiston lähetys voi kestää minuutteja tai useita tunteja datasetin koosta riippuen. Lähetys on onnistunut, kun sovelluksen lokissa näkyy viesti: `Disconnecting SFTP. SFTP has been disconnected.` Kun prosessi on valmis, näet tiedostot [lähettäjäportaalissa](https://submission.finland.ega-archive.org/) Files-sivulla oikean yläkulman valikosta.

[![Fi-FEGA upload application](images/fega/fega_upload.png)](images/fega/fega_upload.png)

### Option 2 - Command line interface {#option-2---command-line-interface}
**Datan salaus crypt4gh CLI:llä**:

1. Crypt4GH-salausohjelman käyttöä varten tarvitaan Python 3.6+. Tarvittaessa Pythonin asennusohjeet löytyvät [täältä](https://www.python.org/downloads/release/python-3810/).

2. Avaa komentorivi/terminaali ja asenna Crypt4GH pip-työkalulla:

    ```
    pip install crypt4gh
    ```

3. Salaa tiedosto [Finnish FEGA:n julkisella salausavaimella](https://a3s.fi/fega-public-keys/fega-pubkey-c4gh.pub) komennolla ```crypt4gh encrypt```:

    ```
    $ crypt4gh encrypt  --recipient_pk fega-pubkey-c4gh.pub < example_file.txt > example_file.txt.c4gh
    ```

    Avaimen määrittely tapahtuu `--recipient_pk` -parametrilla, jolla annetaan käytettävä julkinen avain. Tässä tapauksessa kyseessä on Finnish FEGA:n julkinen avain. `example_file.txt` on alkuperäinen tiedosto ja `example_file.txt.c4gh` tallenettu salattu tiedosto.

**Datan lähetys SFTP CLI:llä (oletus Linuxilla ja MacOS:issa)**:

1. Avaa komentorivi ja yhdistä SFTP-yhteydellä seuraavalla syntaksilla, missä `ega_user` on EGA-tunnuksen käyttäjätunnus (yleensä sähköpostiosoitteesi):

    ```
    sftp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -P 50529 ega_user@admin.sd.csc.fi
    ```

    Käytä salasanana Central EGA -tilisi salasanaa.

2. Siirrä salatut tiedostot tai kansio komennolla *put*, kun yhteys on muodostettu.

    ```
    sftp> put example_file.txt.c4gh
    ```

    Tiedoston lähetys voi kestää minuutteja tai useita tunteja datasetin koosta riippuen.

3. Odota, että prosessi on valmis ennen yhteyden sulkemista. Kun tiedostot näkyvät [lähettäjäportaalissa](https://submission.finland.ega-archive.org/) Files-sivulla, voit sulkea SFTP-yhteyden komennolla `exit`. On tärkeää katkaista yhteys, kun lähetys on valmis.

## Step 6: Metadata submission {#step-6-metadata-submission}

Seuraavaksi voit kuvailla kaikki tutkimukseesi liittyvät tiedot eli julkisen, ei-sensitiivisen metadatan [Finnish FEGA:n lähettäjäportaalissa](https://submission.finland.ega-archive.org/). Julkinen metadata julkaistaan EGA-verkkosivulla datan löytymisen ja uudelleenkäytön helpottamiseksi.

Portaaliin tutustumisen voi aloittaa alla olevasta videosta tai portaalissa saatavana olevan kierroksen avulla (keltaisen kirjan ikoni oikeassa yläkulmassa kirjautuneena).

<iframe width="280" height="155" srcdoc="https://www.youtube.com/embed/eDTNIE8Ex0g?si=QJlYwfAGERAHN-e9" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

Kirjaudu lähettäjäportaaliin EGA-tunnuksilla (käyttäjänimi: yleensä sähköpostiosoitteesi ja salasana).

Lähettäjäportaalissa rekisteröitäviä metadataobjekteja ovat:

- **Study**. Tietoa sekvensointitutkimuksesta. Otsikon tulee olla 3–20 sanan mittainen johdanto projektiin ja kuvauksen 3–5 virkkeen pituinen yhteenveto taustoineen, tavoitteineen ja yksityiskohtineen.

- **Samples**. Kokeen tai analyysin sekvensointinäytteiden tiedot. Näytteitä voi lisätä myös ryhmäsiirtona (batch upload).

- **Experiments**. Sekvensointimenetelmien, protokollien ja laitteiden tiedot.

- **Runs**. Tiedot raakadatasta, joka on syntynyt yksittäisessä sekvensointiajoissa. Näytteet, kokeet ja tiedostot linkittyvät Run-objektien kautta. Soveltuu FASTQ- ja BAM/CRAM-lähetyksiin. Runs-tietoja voi lisätä myös ryhmäsiirtona.

- **Analysis**. Viittaus analyysitiedostoihin, jotka voivat sisältää prosessoitua dataa (VCF), tiettyä raakadataa (BAM/BAI tai CRAM/CRAI) tai fenotyyppitietoa. Liittyy näytteisiin ja tutkimukseen. Analysis on EGA:n oma metadataobjekti, joka linkittää näytteet tiedostoihin. Jos analyysitiedostoja ei ole, voi jatkaa ilman Analysis-metadataa.

- **Dataset**. Tiedostojen kokoelma, joka jakautuu run- ja/tai analysis-objekteihin ja johon sovelletaan käyttörajoituksia. Liittyy Policyyn, johon sisältyy käyttöoikeushakulinkki ja jonka CSC helpdesk luo. Otsikon tulee olla 3–20 sanan mittainen yleiskuvaus aineistosta ja kuvauksen 3–4 virkkeen mittainen sisältöesittely mukaan lukien näytemäärä, tiedostotyyppi ja käytetty teknologia/menetelmä.

Kun kaikki metadata on täytetty, lähetyksen voi viimeistellä. Tämän jälkeen se siirtyy FEGA:n helpdeskiin hyväksyttäväksi ja julkaistavaksi. Julkaisun jälkeen jokaiselle objektilla luodaan pysyvä tunniste eli yksilöllinen accession-numero.

!!! note

    - Dataset-kohtainen **Policy** pitää luoda erikseen CSC helpdeskin toimesta ennen kuin sen voi valita lähettäjäportaalissa. Policy yhdistää datasetin käyttöoikeushakulomakkeeseen, joka on luotu organisaatiossasi SD Apply:ssa (katso [Vaihe 1](./fega-submission.md#step-1-legal-agreements-data-access-committee-and-policies)).
    
    - **Study**, **Samples** ja **Experiment** -metadata voi rekisteröidä ennen tiedostojen lataamista, mutta **Run** ja **Analysis** -objektit voi rekisteröidä vasta, kun tiedostot on ladattu FEGA:an. **Policy**-objektin voi yhdistää vasta, kun kaikki muut metadataobjektit on rekisteröity ja olet rekisteröimässä **Dataset**-metadataa.

## Step 7: Data release {#step-7-data-release}
Aineiston julkaisemiseksi ja hyväksymiseksi ota yhteyttä [CSC Service Deskiin](../../support/contact.md) ja vahvista, että aineisto voidaan julkaista.

CSC helpdesk viimeistelee julkaisuprosessin. Saat vahvistuksen hyväksytystä lähetyksestä sekä julkaisu-, apuraha- yms. käyttöön soveltuvat accession-tunnisteet CSC helpdeskiltä.

!!! note

    Mikäli joku haluaa hakea pääsyä FEGA:aan tallennettuun aineistoosi, hänen tulee klikata datasetin hakulinkkiä EGA:n verkkosivuilla. Linkki ohjaa käyttäjän hakemuslomakkeelle SD Apply -palvelussa. SD Apply on palvelu sensitiivisten datasettien käyttöoikeushallintaan CSC:llä. Käyttölupahakemiseen on olemassa oma [ohje](./sd-apply-access.md).